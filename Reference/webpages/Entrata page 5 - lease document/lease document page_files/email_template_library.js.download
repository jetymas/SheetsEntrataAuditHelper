var EmailTemplateLibrary	= {};
EmailTemplateLibrary.ComposeTemplateDialog = {};
EmailTemplateLibrary.ComposeTemplateDialog.Preview = {};
objExitTagPath = '';
var strSelectTemplateErrorMsg                   = __( 'Please select at least one property.' );
var strTemplateNameRequiredErrorMsg             = __( 'Template Name is required.' );
var strTemplateNameLengthValidationErrorMsg     = __( 'Template Name should contain at least 2 characters.' );
var strRecipientTypeRequiredErrorMsg            = __( 'Recipient Type is required.' );

var intPreheaderTotalChar = 0,
	PREHEADER_LENGTH		= 250;
function preheaderCharacterCounter( strElementId, strCharCounterId ) {
	var intMessageLength 			= $( '#' + strElementId ).val().length,
		intMessageLengthWithNewLine = ( $( '#' + strElementId ).val().match( /\n/g )||[] ).length;
	intPreheaderTotalChar 	    = intMessageLength + intMessageLengthWithNewLine;

	if ( intPreheaderTotalChar > PREHEADER_LENGTH ) {
		$( '#' + strElementId ).val( $( '#' + strElementId ).val().substring( 0, ( PREHEADER_LENGTH - ( intMessageLengthWithNewLine ) ) ) );
	} else {
		$( '#' + strCharCounterId ).html( PREHEADER_LENGTH - ( intPreheaderTotalChar ) );
	}

}

function preventUserToAddPreheader( objEvent ) {
	if( ( ( intPreheaderTotalChar + 1 ) > PREHEADER_LENGTH && ( objEvent.keyCode == 32 || objEvent.keyCode > 47 || objEvent.keyCode == 13 ) ) ||  ( ( ( intPreheaderTotalChar + 2 ) > PREHEADER_LENGTH ) && objEvent.keyCode == 13 ) ) {
		objEvent.preventDefault();
	}
}

EmailTemplateLibrary.ComposeTemplateDialog.selectTemplate = function( id ) {
	var boolAttrDisabled = false;

	if( typeof undefined !== typeof $( '#scheduled_email_type_id' ).attr( 'disabled' ) ) {
		boolAttrDisabled = true;
		$( '#scheduled_email_type_id' ).removeAttr( 'disabled' );
	}
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	$('#system_message_template_id').val( id );
	psi.patterns.ajaxRequest({
		url					: objExitTagPath.exitTags.edit_email_template_for_template_library,
		data				: $('#edit-email-template').serialize(),
		success				: function( strResponse ) {
			$( '#' + strEmailTemplate ).html( strResponse );

			var arrstrImageSlots = [ 'header_main_image', 'left_image', 'center_image', 'right_image' ];
			arrstrImageSlots.forEach( function ( strImageSlot ) {
				if( 0 == $( '#' + strImageSlot ).length ) {
					$( '#' + strImageSlot + '_company_media_file' ).attr( 'title', '' );
					$( '#' + strImageSlot + '_company_media_file' ).val( '' );
				} else {
					$( '#' + strImageSlot ).attr( 'src', $( '#' + strImageSlot + '_company_media_file' ).attr( 'title' ) );
					$( '#' + strImageSlot ).attr( 'data-link', $( '#' + strImageSlot + '_link' ).val() );
					$( '#' + strImageSlot ).attr( 'data-link-target', $( '#' + strImageSlot + '_link_target' ).val() );
				}
			} );

			$('.compose-temlplate-toolbar').show();
			$('.choose-template-label').hide();
			$('#header_footer_option_display').show();
			$('#system_message_tempalte_name').html('<label class="bold">' + __( 'Selected Layout: {%s, layoutName}', { layoutName: arrstrSystemMessageTemplateNames[id] } ) + '</label>');
			EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel();
			EmailTemplateLibrary.ComposeTemplateDialog.changePreviewButtonsStatus();
			EmailTemplateLibrary.ComposeTemplateDialog.changeDefaultLogoStatus( arrstrHeaderFooterOptions );
			EmailTemplateLibrary.ComposeTemplateDialog.loadDefaultMergeFields();

			if( boolAttrDisabled ) {
				$( '#scheduled_email_type_id' ).attr( 'disabled', true );
			}

		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.showTemplates = function() {
	$('.cke_top').hide();
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	psi.patterns.ajaxRequest({
		url					: objExitTagPath.exitTags.view_email_templates_for_template_library,
		strElementSelector	: '#' + strEmailTemplate
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.SaveEmailTemplate = function( boolShowAlertMessage ) {
	var boolAttrDisabled = false;
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( boolShowAlertMessage ) {
		if( true == $('#edit-email-template').find( '#js-clear-all-properties' ).hasClass( 'disabled' ) ) {
			$( '#modal_container1' ).scrollTop( 0 );
			objExitTagPath.showMessage( 'error', strSelectTemplateErrorMsg );
			GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', strSelectTemplateErrorMsg );
			return false;
		}

		if( '' == $( '#email_template_name' ).val() ) {
			$( '#modal_container1' ).scrollTop(0);
			objExitTagPath.showMessage( 'error', strTemplateNameRequiredErrorMsg );
			GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', strTemplateNameRequiredErrorMsg );
			return false;
		}

		if( 2 > $( '#email_template_name' ).val().length ) {
			$( '#modal_container1' ).scrollTop(0);
			objExitTagPath.showMessage( 'error', strTemplateNameLengthValidationErrorMsg );
			GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', strTemplateNameLengthValidationErrorMsg );
			return false;
		}

		if( 0 == $( '#scheduled_email_type_id' ).val() ) {
			$( '#modal_container1' ).scrollTop(0);
			objExitTagPath.showMessage( 'error', strRecipientTypeRequiredErrorMsg );
			GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', strRecipientTypeRequiredErrorMsg );
			return false;
		}

		if( $( '#email_template_subject' ).val() && false == EmailTemplateLibrary.ComposeTemplateDialog.validateEmailSubject() ) {
			return false;
		}
	}

	if( '' == $( '#system_message_template_id' ).val() ) {
		$( '#system_message_template_id' ).val( '2' );
	}

	if( $( '.cke_focus' ).attr( 'title' ) ) {
		EmailTemplateLibrary.ComposeTemplateDialog.focusOutAndSaveContentData();
	}

	if( typeof undefined !== typeof $( '#scheduled_email_type_id' ).attr( 'disabled' ) ) {
		boolAttrDisabled = true;
		$( '#scheduled_email_type_id' ).removeAttr( 'disabled' );
	}

	psi.patterns.ajaxRequest( {
		type: 'POST',
		url: objExitTagPath.exitTags.insert_or_update_email_template,
		dataType: 'json',
		data: $( '#edit-email-template' ).serialize(),
		beforeSend: function() {
			$( '#save_email_template_button' ).addClass( 'disabled' );
			if( boolShowAlertMessage ) {
				objExitTagPath.showMessage( 'warning', __( 'Saving...' ), 'ajax_save_message', 3000 );
			}
		},
		success: function( objResponse ) {
			if( '' == $( '#email_template_id' ).val() ) {
				$( '#email_template_id' ).val( objResponse.id );
			}
			if( '' == $( '#save_email_template_button' ).val() ) {
				$( '#save_email_template_button' ).val( objResponse.system_message_template_id );
			}

			$( '#save_email_template_button' ).removeClass( 'disabled' );

			if( boolAttrDisabled ) {
				$( '#scheduled_email_type_id' ).attr( 'disabled', true );
			}

			if( boolShowAlertMessage ) {
				if( false == objResponse.status ) {
					strmessageType = 'error';
					objExitTagPath.showMessage( strmessageType, objResponse.msg );
					GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', objResponse.msg );
					return false;
				} else {
					psi.patterns.closeLargeDialog();
					emailTemplateLibrary.getDOMrefs().adjustColumnHeight();
					emailTemplateLibrary.reloadFilesAndFolders( 'load_files' );
					emailTemplateLibrary.slideBanner( 'down', ['successBanner'] );
					if( false == $( '#is_email_template_update' ).val() ) {
						$( '#success-title' ).text( __( 'Email Template added successfully' ) );
					} else {
						$( '#success-title' ).text( __( 'Email Template updated successfully' ) );
					}

					setTimeout( function() {
						var banners = ['successBanner']
						if( emailTemplateLibrary.getMediaSelections().length < 1 ) {
							banners.push( 'selectTools' );
						}
						emailTemplateLibrary.slideBanner( 'up', banners );
						emailTemplateLibrary.adjustColumnHeight();
					}, 5000 );
				}
			}
		}
	} );
};

EmailTemplateLibrary.ComposeTemplateDialog.changePreviewButtonsStatus = function() {
	if( '' == $.trim( $('#system_message_template_id').val() ) ) {
		$( '#preview-buttons .button' ).addClass( 'disabled' );
	} else {
		$( '#preview-buttons .button' ).removeClass( 'disabled' );
	}
};

EmailTemplateLibrary.ComposeTemplateDialog.showPreview = function( strPreviewMode, objElement ) {

	var boolAttrDisabled = false;
	if( $('.preview-msg').hasClass('disabled') ) { return false; }
	if( '' == $('#system_message_template_id').val() ) { return false; }

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

		if( true == $('#edit-email-template').find( '#js-clear-all-properties' ).hasClass( 'disabled' ) ) {
			$( '#modal_container1' ).scrollTop( 0 );
			objExitTagPath.showMessage( 'error', strSelectTemplateErrorMsg );
			GtmTracking.addError( 'modal interaction', '', 'preview', 'email template library > create new template', strSelectTemplateErrorMsg );
			return false;
		}

	if( 0 == $( '#scheduled_email_type_id' ).val() ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strRecipientTypeRequiredErrorMsg );
		GtmTracking.addError( 'modal interaction', '', 'preview', 'email template library > create new template', strRecipientTypeRequiredErrorMsg );
		return false;
	}

	if( '' == $( '#email_template_name' ).val() ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strTemplateNameRequiredErrorMsg );
		GtmTracking.addError( 'modal interaction', '', 'preview', 'email template library > create new template', strTemplateNameRequiredErrorMsg );
		return false;
	}

	if( 2 > $( '#email_template_name' ).val().length ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strTemplateNameLengthValidationErrorMsg );
		GtmTracking.addError( 'modal interaction', '', 'preview', 'email template library > create new template', strTemplateNameLengthValidationErrorMsg );
		return false;
	}

	if( typeof undefined !== typeof $( '#scheduled_email_type_id' ).attr( 'disabled' ) ) {
		boolAttrDisabled = true;
		$( '#scheduled_email_type_id' ).removeAttr( 'disabled' );
	}

	if( $( '.cke_focus' ).attr( 'title' ) ) {
		EmailTemplateLibrary.ComposeTemplateDialog.focusOutAndSaveContentData();
	}

	psi.patterns.ajaxRequest( {
		type: 'POST',
		url: objExitTagPath.exitTags.insert_or_update_email_template,
		dataType: 'json',
		data: $( '#edit-email-template' ).serialize(),
		success: function( objResponse ) {
			if( '' == $( '#email_template_id' ).val() ) {
				$( '#email_template_id' ).val( objResponse.id );
			}

			if( boolAttrDisabled ) {
				$( '#scheduled_email_type_id' ).attr( 'disabled', true );
			}

			if( false == objResponse.status ) {
				strmessageType = 'error';
				objExitTagPath.showMessage( strmessageType, objResponse.msg );
				GtmTracking.addError( 'modal interaction', '', 'preview', 'email template library > create new template', objResponse.msg );
				return false;
			}

			if( 'desktop' == strPreviewMode ) {
				var strUrl = objExitTagPath.exitTags.preview_email_template + '&preview_mode=desktop&is_preview=1&email_template[id]=' + $('#email_template_id').val() + '&call_from=' + strCallFromSection;
				psi.patterns.loadDialog({
					title		: __( 'Email Preview' ),
					strContentId: 'email_template_preview',
					strUrl		: strUrl,
					width		:1055,
					height		:960,
					resizable	: true
				});
				GtmTracking.addModalTimestampStart( 'preview', 'email template library > create new template > email preview' );
			}
		}
	});

};

EmailTemplateLibrary.ComposeTemplateDialog.addSlotImage = function( strSlotName, intWidth, intHeight ) {
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	gStrImageSlot = 	'#'+strSlotName;

	if( '' == $(gStrImageSlot).attr( 'src' ) ) {
		psi.mediaLibrary.initiateMediaLibrary({
			url: objExitTagPath.exitTags.load_media_library,
			params: {
				referer_id: strSlotName + '_company_media_file',
				referer_div: strSlotName,
				marketing_media_type_id: objExitTagPath.intMediaTypeId,
				marketing_media_sub_type_id: objExitTagPath.intMarketingMediaSubTypeId
			},
			company_media_file: {
				location_width: intWidth,
				location_height: intHeight,
			}
		});

		$( 'img#' + strSlotName ).one( 'load', function() {
			EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel();
		});

		$( gStrImageSlot ).on( 'load', function() {
			$( gStrImageSlot + '_company_media_file' ).attr( { 'title': $( gStrImageSlot ).attr( 'src' ) } );
		});

	} else {
		$(gStrImageSlot).attr( 'src', '' );
		$(gStrImageSlot+'_company_media_file').attr( { 'value':'', 'title':'' } );
		EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel();
		gStrImageSlot = '';
	}
};

EmailTemplateLibrary.ComposeTemplateDialog.addLinkToSlotImage = function( strSlotName ) {

	var arrLink		= $( '#' + strSlotName ).attr( 'data-link');
	var strTarget	= $( '#' + strSlotName ).attr( 'data-link-target');

	var arrLinkData = {
		slot_name	: strSlotName,
		url			: arrLink,
		target		: strTarget
	};

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	psi.patterns.loadDialog({
		width:600,
		height:250,
		strUrl: objExitTagPath.exitTags.edit_link_to_image_email_template_library,
		strContentId:'link_image',
		title:__( 'Link' ),
		method:'post',
		data: arrLinkData,
		datatype:'json'
	});
	GtmTracking.addModalTimestampStart( 'link', 'email template library > create new template > link' );
};

EmailTemplateLibrary.ComposeTemplateDialog.submitLinkToImage = function() {
	var strLink		  = $( "#link_url" ).val();
	var strLinkTarget = $( "#link_target" ).val();
	var strSlotName	  = $( '#slot_name' ).val();
	var valUrl		  = /^(http|https|ftp):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?/i;

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( true == valUrl.test( strLink ) ) {
		$( '#link_image' ).dialog('close');
		$( '#' + strSlotName + '_link').val( strLink );
		$( '#' + strSlotName ).attr( 'data-link', strLink );
		$( '#' + strSlotName + '_link_target').val( strLinkTarget );
		$( '#' + strSlotName ).attr( 'data-link-target', strLinkTarget );
	} else {
		objExitTagPath.showMessage( 'error', __( 'Please enter correct URL.' ), 'show-error-msg' );
		GtmTracking.addError( 'modal interaction', '', 'save', 'link', 'Please enter correct URL.' );
	}

};

EmailTemplateLibrary.ComposeTemplateDialog.cancelLinkToImage = function() {
	$( '#link_image' ).dialog('close');
};

function setMedia() {
	var intFileId 	 	= getCroppedMediaFileId();
	var strFieldUri 	= getCroppedMediaFileURI();

	if( '' != gStrImageSlot ) {
		$(gStrImageSlot).attr( 'src', strFieldUri );
		$(gStrImageSlot+'_company_media_file').attr( { 'value': intFileId, 'title': strFieldUri } );

		gStrImageSlot = '';
		EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel();
	}

	//For Mediaimage Plugin
	$('#editor_image').attr( 'src', strFieldUri );
};

EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel = function() {
	$( '.image_slot' ).each(function( index ) {

		if( '' == $(this).find('img').attr('src') ) {
			$(this).find('a').html( '<i class="edit"></i> ' + __( 'Edit' ) );
			$(this).find('img').attr('data-link',"");
			$(this).find('img').attr('data-link-target',"");

			var strSlotName = $(this).find('img').attr('id');
			$( '#' + strSlotName + '_link').val("");
			$( '#' + strSlotName + '_link_target').val("");
			$(this).find('.image-link-button').hide();
		} else {
			$(this).find('a').html( '<i class="delete"></i> ' + __( 'Remove' ) );
			$(this).find('.image-link-button').show();
		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.loadPropertyLeadSources = function() {

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	var strUrl = objExitTagPath.exitTags.view_property_lead_sources_template_library;
	psi.patterns.ajaxRequest({
		type	: 'POST',
		url		: strUrl,
		dataType: 'json',
		data	: $( '#edit-email-template' ).serialize(),
		success	: function( objResponse ) {
			arrmixLeadSources = objResponse.lead_sources;

		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.loadDefaultMergeFields = function() {
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();
	var strUrl = objExitTagPath.exitTags.view_default_merge_fields_template_library;
	psi.patterns.ajaxRequest({
		type	: 'POST',
		url		: strUrl,
		dataType: 'json',
		data	: $( '#edit-email-template' ).serialize(),
		success	: function( objResponse ) {
			arrmixDefaultMergeFields =  objResponse;
		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.loadPropertyAmenities = function() {

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	var strUrl = objExitTagPath.exitTags.view_property_amenities_template_library;

	psi.patterns.ajaxRequest({
		type        : 'POST',
		url         :  strUrl,
		dataType    : 'json',
		data        : $( '#edit-email-template' ).serialize(),
		success     : function( objResponse ) {
			arrmixAmenities = objResponse.amenities;
		}
	});
};
EmailTemplateLibrary.ComposeTemplateDialog.init = function() {

	var lastScrollTop = $('div.modal-body-container').scrollTop();

	$( 'div.modal-body-container' ).on( 'scroll', function() {
		var currentTop = parseInt( $('div#cke_' + $('div.cke_focus').attr('id') ).css('top'));

		if($(this).scrollTop() > lastScrollTop) {
			if( $('div.cke_focus').length == 1 ) {
				$('div#cke_' + $('div.cke_focus').attr('id')).css('top', Number( currentTop - ($(this).scrollTop() - lastScrollTop) ) + 'px');
			}
		} else {
			if( $('div.cke_focus').length == 1 ) {
				$('div#cke_' + $('div.cke_focus').attr('id')).css('top', Number( currentTop + (lastScrollTop - $(this).scrollTop()) ) + 'px');
			}
		}

		lastScrollTop = $(this).scrollTop();
	});

	if (!$.curCSS) $.curCSS = $.css;

	EmailTemplateLibrary.ComposeTemplateDialog.changePreviewButtonsStatus();

	$( '#changeTemplate' ).on( 'click', function() {
		$('#system_message_template_id').val('');
		EmailTemplateLibrary.ComposeTemplateDialog.showTemplates();
		EmailTemplateLibrary.ComposeTemplateDialog.changePreviewButtonsStatus();
		$('.compose-temlplate-toolbar').hide();
		$('.choose-template-label').show();
		$('#header_footer_option_display').hide();
	});

	$( '#preheader_email_template' )
		.on( 'keyup', function() {
			preheaderCharacterCounter( 'preheader_email_template', 'email-template-preheader-text-count' );
		})
		.on( 'keydown', function( objEvent ) {
			preventUserToAddPreheader( objEvent );
		});

		 preheaderCharacterCounter( 'preheader_email_template', 'email-template-preheader-text-count' );

};

EmailTemplateLibrary.ComposeTemplateDialog.loadFormData = function() {
	if( $('#system_message_template_id').val() ) {
		EmailTemplateLibrary.ComposeTemplateDialog.selectTemplate( $('#system_message_template_id').val() );
	} else {
		EmailTemplateLibrary.ComposeTemplateDialog.showTemplates();
	}

};

EmailTemplateLibrary.ComposeTemplateDialog.focusOutAndSaveContentData = function() {
	var strTitle	= $('.cke_focus').attr('title');
	var editorId	= strTitle.split(",");
	editorId		= editorId[1].trim();
	var editor		= CKEDITOR.instances[editorId];
	var strData 	= editor.getData();

	strData = strData.replace( /<sampletext>(.*)<\/sampletext>/, '' );
	$('#TEXT_'+editorId).val( strData );
};

EmailTemplateLibrary.ComposeTemplateDialog.discardEmailTemplate = function() {

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	var strUrl = objExitTagPath.exitTags.discard_email_template;
	strUrl += '&email_template[id]=' + $('#email_template_id').val();

	psi.patterns.ajaxRequest({
		type	: 'POST',
		url		: strUrl,
		dataType: 'json',
		success : function( objResponse ) {
			if( true == objResponse.status || false == objResponse.status ) {
				psi.patterns.closeLargeDialog();
				emailTemplateLibrary.getDOMrefs().adjustColumnHeight();
				emailTemplateLibrary.reloadFilesAndFolders( 'load_files' );
				if( false != $('#is_email_template_update').val() )
				{
					emailTemplateLibrary.slideBanner( 'down', ['deleteBanner'] );
					$( '#delete-title' ).text( __( 'Email Template deleted successfully' ) );
					setTimeout( function() {
						var banners = ['deleteBanner']
						if( emailTemplateLibrary.getMediaSelections().length < 1 ) {
							banners.push( 'selectTools' );
						}
						emailTemplateLibrary.slideBanner( 'up', banners );
						emailTemplateLibrary.adjustColumnHeight();
					}, 5000 );
				}
			}
		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.validateEmailSubject = function() {
	var strSubject = $('#email_template_subject').val();
	var boolSubject = true;

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( strSubject.match( /\\|<\/?\b(br|basefont|hr|input|source|frame|param|area|meta|!--|col|link|option|base|img|wbr|!DOCTYPE|a|abbr|acronym|address|applet|article|aside|audio|b|bdi|bdo|bgsound|big|blink|blockquote|body|button|canvas|caption|center|cite|code|colgroup|command|content|data|datalist|dd|del|details|dfn|dialog|dir|div|dl|dt|element|em|embed|fieldset|figcaption|figure|font|footer|form|frameset|head|header|hgroup|h1|h2|h3|h4|h5|h6|html|i|iframe|image|ins|isindex|kbd|keygen|label|legend|li|listing|map|main|mark|marquee|menu|menuitem|meter|multicol|nav|nextid|nobr|noembed|noframes|noscript|object|ol|optgroup|output|p|plaintext|picture|pre|progress|q|rb|rp|rt|rtc|ruby|s|samp|script|section|select|shadow|slot|small|span|spacer|strike|strong|style|sub|summary|sup|table|tbody|td|template|textarea|tfoot|th|thead|time|title|tr|track|tt|u|ul|var|video|xmp)\b.*?>?/i ) ) {
		objExitTagPath.showMessage( 'error', __( 'Please do not use HTML tag or slash (\\) in subject.' ) );
		GtmTracking.addError( 'modal interaction', '', 'save template', 'email template library > create new template', 'Please do not use HTML tag or slash (\\) in subject.' );
		$('#email_template_subject').focus();
		boolSubject = false;
	}

	return boolSubject;
};

EmailTemplateLibrary.ComposeTemplateDialog.changeDefaultLogoStatus = function( arrstrHeaderFooterOptions ) {
	var intSelectedValue = $('#display_items').val();
	var strHeaderPlaceHolder = __( 'Property Header' );
	var strFooterPlaceHolder = __( 'Property Footer' );

	$('#headerPlaceHolder').remove();
	$('#footerPlaceHolder').remove();
	$('#logoPlaceHolder').remove();

		switch( intSelectedValue ) {
			case '1':
				$('#contents').before( '<div id="logoPlaceHolder">'+__('Logo will display here') + '</div>' );
				break;
			case '2':
				$('#contents').before( '<div id="headerPlaceHolder">' + strHeaderPlaceHolder + '</div>' );
				break;
			case '3':
				$('#contents').after( '<div id="footerPlaceHolder">' + strFooterPlaceHolder + '</div>' );
				break;
			case '4':
				$('#contents').before( '<div id="headerPlaceHolder">' + strHeaderPlaceHolder + '</div>' );
				$('#contents').after( '<div id="footerPlaceHolder">' + strFooterPlaceHolder + '</div>' );
				break;
			default:
			// default block
		}

}

EmailTemplateLibrary.ComposeTemplateDialog.validateEmailAddress = function( strEmail ) {
	var pattern = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;

	if( pattern.test( strEmail ) ) {
		return true;
	} else {
		return false;
	}
};

EmailTemplateLibrary.ComposeTemplateDialog.reloadEmailTemplate = function( ) {
	var strHeaderMainImage = $( '#header_main_image' ).attr( 'src' );
	var strLeftImage = $( '#left_image' ).attr( 'src' );
	var strCenterImage = $( '#center_image' ).attr( 'src' );
	var strRightImage = $( '#right_image' ).attr( 'src' );

	var strHeaderMainImageLink = $( '#header_main_image_link' ).val();
	var strLeftImageLink = $( '#left_image_link' ).val();
	var strCenterImageLink = $( '#center_image_link' ).val();
	var strRightImageLink = $( '#right_image_link' ).val();

	var strHeaderMainImageTarget = $( '#header_main_image_link_target' ).val();
	var strLeftImageTarget = $( '#left_image_link_target' ).val();
	var strCenterImageTarget = $( '#center_image_link_target' ).val();
	var strRightImageTarget = $( '#right_image_link_target' ).val();

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	psi.patterns.ajaxRequest( {
		url: objExitTagPath.exitTags.edit_email_template_for_template_library,
		strElementSelector: '#' + strEmailTemplate,
		data: $( '#edit-email-template' ).serialize(),
		success: function( strResponse ) {
			$( '#' + strEmailTemplate ).html( strResponse );
			$( '#header_main_image' ).attr( 'src', strHeaderMainImage );
			$( '#left_image' ).attr( 'src', strLeftImage );
			$( '#center_image' ).attr( 'src', strCenterImage );
			$( '#right_image' ).attr( 'src', strRightImage );
			$( '#header_main_image' ).attr( 'data-link', strHeaderMainImageLink );
			$( '#left_image' ).attr( 'data-link', strLeftImageLink );
			$( '#center_image' ).attr( 'data-link', strCenterImageLink );
			$( '#right_image' ).attr( 'data-link', strRightImageLink );
			$( '#header_main_image' ).attr( 'data-link-target', strHeaderMainImageTarget );
			$( '#left_image' ).attr( 'data-link-target', strLeftImageTarget );
			$( '#center_image' ).attr( 'data-link-target', strCenterImageTarget );
			$( '#right_image' ).attr( 'data-link-target', strRightImageTarget );

			if( true == $( '#header_main_image_company_media_file' ).attr( 'title' ) ) {
				$( '#header_main_image' ).attr( 'src', $( '#header_main_image_company_media_file' ).attr( 'title' ) );
				$( '#header_main_image' ).attr( 'data-link', $( '#header_main_image_link' ).val() );
				$( '#header_main_image' ).attr( 'data-link-target', $( '#header_main_image_link_target' ).val() );
			}

			if( true == $( '#left_image_company_media_file' ).attr( 'title' ) ) {
				$( '#left_image' ).attr( 'src', $( '#left_image_company_media_file' ).attr( 'title' ) );
				$( '#left_image' ).attr( 'data-link', $( '#left_image_link' ).val() );
				$( '#left_image' ).attr( 'data-link-target', $( '#left_image_link_target' ).val() );
			}

			if( true == $( '#center_image_company_media_file' ).attr( 'title' ) ) {
				$( '#center_image' ).attr( 'src', $( '#center_image_company_media_file' ).attr( 'title' ) );
				$( '#center_image' ).attr( 'data-link', $( '#center_image_link' ).val() )
				$( '#center_image' ).attr( 'data-link-target', $( '#center_image_link_target' ).val() );
			}

			if( true == $( '#right_image_company_media_file' ).attr( 'title' ) ) {
				$( '#right_image' ).attr( 'src', $( '#right_image_company_media_file' ).attr( 'title' ) );
				$( '#right_image' ).attr( 'data-link', $( '#right_image_link' ).val() )
				$( '#right_image' ).attr( 'data-link-target', $( '#right_image_link_target' ).val() );
			}

			$( '.compose-temlplate-toolbar' ).show();
			$( '.choose-template-label' ).hide();

			EmailTemplateLibrary.ComposeTemplateDialog.changePreviewButtonsStatus();
			EmailTemplateLibrary.ComposeTemplateDialog.updateImageButtonLabel();
			EmailTemplateLibrary.ComposeTemplateDialog.changeDefaultLogoStatus( arrstrHeaderFooterOptions );
			EmailTemplateLibrary.ComposeTemplateDialog.loadDefaultMergeFields();
		}
	} );
};

EmailTemplateLibrary.ComposeTemplateDialog.createEmailAttachment = function() {
	var boolAttrDisabled = false;
	var intAttachedFileCount = parseInt( $('#attachedFileList').find('li').length );

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( true == $( '#edit-email-template' ).find( '#js-clear-all-properties' ).hasClass( 'disabled' ) ) {
		$( '#modal_container1' ).scrollTop( 0 );
		objExitTagPath.showMessage( 'error', strSelectTemplateErrorMsg, 'alert_message' );
		GtmTracking.addError( 'modal interaction', '', 'add attachments', 'email template library > create new template', strSelectTemplateErrorMsg );
		return false;
	}

	if( 0 == $( '#scheduled_email_type_id' ).val() ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strRecipientTypeRequiredErrorMsg, 'alert_message' );
		GtmTracking.addError( 'modal interaction', '', 'add attachments', 'email template library > create new template', strRecipientTypeRequiredErrorMsg );
		return false;
	}

	if( '' == $( '#email_template_name' ).val() ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strTemplateNameRequiredErrorMsg, 'alert_message' );
		GtmTracking.addError( 'modal interaction', '', 'add attachments', 'email template library > create new template', strTemplateNameRequiredErrorMsg );
		return false;
	}

	if( 2 > $( '#email_template_name' ).val().length ) {
		$( '#modal_container1' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strTemplateNameLengthValidationErrorMsg, 'alert_message' );
		GtmTracking.addError( 'modal interaction', '', 'add attachments', 'email template library > create new template', strTemplateNameLengthValidationErrorMsg );
		return false;
	}

	if( typeof undefined !== typeof $( '#scheduled_email_type_id' ).attr( 'disabled' ) ) {
		boolAttrDisabled = true;
		$( '#scheduled_email_type_id' ).removeAttr( 'disabled' );
	}

	if( '' == $('#system_message_template_id').val() ) {
		$( '#system_message_template_id' ).val( '2' );
	}

	if( $( '.cke_focus' ).attr( 'title' ) ) {
		EmailTemplateLibrary.ComposeTemplateDialog.focusOutAndSaveContentData();
	}

	psi.patterns.ajaxRequest( {
		type: 'POST',
		url: objExitTagPath.exitTags.insert_or_update_email_template,
		dataType: 'json',
		data: $( '#edit-email-template' ).serialize(),
		success: function( objResponse ) {
			if( '' == $( '#email_template_id' ).val() ) {
				$( '#email_template_id' ).val( objResponse.id );
			}

			if( boolAttrDisabled ) {
				$( '#scheduled_email_type_id' ).attr( 'disabled', true );
			}

			if( false == objResponse.status ) {
				strmessageType = 'error';
				objExitTagPath.showMessage( strmessageType, objResponse.msg );
				GtmTracking.addError( 'modal interaction', '', 'add attachments', 'email template library > create new template', objResponse.msg );
				return false;
			}

			psi.patterns.loadDialog( {
				title: __( 'Upload' ),
				strContentId: "create_email_attachment_dlg",
				strUrl: objExitTagPath.exitTags.create_email_attachment_template_library + '&attached_file_count=' + intAttachedFileCount + '&email_template_id=' + $( '#email_template_id' ).val(),
				width: 450,
				height: 300,
				resizable: false,
			} );
			GtmTracking.addModalTimestampStart( 'add attachments', 'email template library > create new template > upload' );
		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.uploadFile = function() {
	var strFileName = $("#email_template_file_name").val();

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( '' == strFileName ) {
		objExitTagPath.showMessage('error',__( 'Please select a file to upload' ), 'upload_file_msg' );
		GtmTracking.addError( 'modal interaction', '', 'upload', 'email template library > create new template > upload', 'Please select a file to upload' );
	} else {
		psi.patterns.showLoadingImage({
			strElementSelector: '#create_email_attachment_dlg'
		});
		$( '#form_upload_email_attachment' ).ajaxSubmit({
			target: '#create_email_attachment_dlg',
			dataType: 'json',
			success: function( returnedData ) {
				for( var i = 0; i < returnedData.length; i++ ) {
					if( true == returnedData[i].status ) {
						EmailTemplateLibrary.ComposeTemplateDialog.addFileAttachment( returnedData[i].id, returnedData[i].title );
						$( '#create_email_attachment_dlg' ).dialog( 'close' );
					} else {
						objExitTagPath.showMessage('error',returnedData[i].message, 'upload_file_msg' );
						GtmTracking.addError( 'modal interaction', '', 'upload', 'email template library > create new template > upload', returnedData[i].message );
						$('#form_upload_email_attachment')[0].reset();

						var fileLabel = $( '#form_upload_email_attachment' ).find( 'label.file-label' );
						if( 0 !== fileLabel.length ) {
							fileLabel.find('span').text( __( 'Choose File' ) );
						}
					}
				}
				EmailTemplateLibrary.ComposeTemplateDialog.SaveEmailTemplate();
				psi.patterns.removeLoadingImage({
					strElementSelector: '#create_email_attachment_dlg'
				});
			}
		});
	}
	return false;
};

EmailTemplateLibrary.ComposeTemplateDialog.createAttachments = function() {
	$('#email_template_file_name').change( function() {
		EmailTemplateLibrary.ComposeTemplateDialog.validateFileExtension( this );
	} );
};

EmailTemplateLibrary.ComposeTemplateDialog.validateFileExtension = function( objFileElement ) {
	var arrobjFiles = $(objFileElement).get(0).files;
	var arrstrAllowedExtensions = new Array( 'bmp', 'gif', 'jpe', 'jpeg', 'png', 'tif', 'jpg', 'ico', 'txt', 'tiff', 'psd', 'pdf', 'doc', 'docx', 'xls', 'xlsx' );
	var arrstrInvalidExtensions = [];
	var boolValidExtension = true;

	for( var i = 0; i < arrobjFiles.length; i++ ) {
		var strFileExtension = arrobjFiles[i]['name'].split( '.' ).pop().toLowerCase();
		if( -1 == $.inArray( strFileExtension, arrstrAllowedExtensions ) && -1 == $.inArray( strFileExtension, arrstrInvalidExtensions ) ) {
			arrstrInvalidExtensions.push( strFileExtension );
			boolValidExtension = false;
		}
	}

	if( false == boolValidExtension ) {
		var strMessage = __( '{%s, file_extension} is not a supported extension.', { file_extension: arrstrInvalidExtensions.join() } );
		$( '#upload_file_msg' ).html( '<p class="alert error slim"><i></i>' + strMessage + '</p>' ).show().delay( 3000 ).fadeOut( 1000 );
		GtmTracking.addError( 'modal interaction', '', 'upload', 'email template library > create new template > upload', strMessage );
		objFileElement.value = '';
		return false;
	}
};

EmailTemplateLibrary.ComposeTemplateDialog.addFileAttachment = function( intFileId, strFileTitle ) {
	if( $('.file_attachments_template_library[value=""]').length > 0 ) {
		$('input.file_attachments_template_library[value=""]:first').attr( { 'value':intFileId, 'title':strFileTitle } );
	}

	EmailTemplateLibrary.ComposeTemplateDialog.updateFileAttachmentList();
};

EmailTemplateLibrary.ComposeTemplateDialog.updateFileAttachmentList = function() {
	$('#attachedFileList').html('');

	$('.file_attachments_template_library').each(function( index ) {
		if( '' != $(this).attr('value') ) {
			var intFileId = $(this).attr('value');
			var strFileTitle = $(this).attr('title');

			var strFileLink = '';
			strFileLink += "<li id='file_attachment_"+intFileId+"'>";
			strFileLink += "<a href='#' onclick='EmailTemplateLibrary.ComposeTemplateDialog.deleteFileAttachment("+ intFileId +");'><i class='trash'></i></a>";
			strFileLink += "<a href='#' onclick='EmailTemplateLibrary.ComposeTemplateDialog.downloadFileAttachment("+ intFileId +");'>"+ strFileTitle +"</a>";
			strFileLink += "</li>";

			$( '#attachedFileList' ).append( strFileLink );
		}
	});

	if( 0 < $(".file_attachments_template_library[value='']").length ) {
		$('#attachFile').removeClass( 'hide' );
		$('#attachFile').show();
	} else {
		$('#attachFile').hide();
	}
};

EmailTemplateLibrary.ComposeTemplateDialog.downloadFileAttachment = function( intFileId ) {

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	location.href = objExitTagPath.exitTags.download_email_attachment_template_library + '&email_template_attachment[id]=' + intFileId;
};

EmailTemplateLibrary.ComposeTemplateDialog.deleteFileAttachment = function( intFileId ) {

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	psi.patterns.ajaxRequest({
		url 	: objExitTagPath.exitTags.delete_email_attachment_template_library + '&email_template_attachment[id]=' + intFileId,
		type 	: 'POST',
		dataType: 'json',
		success	: function( objResponse ) {
			if( true == objResponse.status ) {
				$(".file_attachments_template_library[value='" + intFileId + "']").attr( { 'value':'', 'title':'' });
				EmailTemplateLibrary.ComposeTemplateDialog.updateFileAttachmentList();
				EmailTemplateLibrary.ComposeTemplateDialog.SaveEmailTemplate( false );
			} else {
				objExitTagPath.showMessage( 'warning', objResponse.message, 'ajax_save_message', 2000 );
				GtmTracking.addError( 'modal interaction', '', 'delete', 'email template library > create new template', objResponse.message );
			}
		}
	});
};

EmailTemplateLibrary.ComposeTemplateDialog.Preview.init = function() {
	psi.patterns.bindEssentials();
	var propertiesSelectionChanged = false;

	$(document).ready( function() {
		EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadPropertyComboBox();
		EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadRecipientComboBox();

		$('#content_update').click( function(){
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.showEmailTemplateContentPreview( $('.js-toggle-view.selected').data('mode'), this );
		});

		$('#desktop_button').click( function() {
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.showEmailTemplateContentPreview( 'desktop', this );
		});

		$('#mobile_button').click( function() {
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.showEmailTemplateContentPreview( 'mobile', this );
		});

		$('#send_test_message').click( function() {
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.sendTestEmail( this );
		});

		$('#print_message_content').click( function(){
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.printMessageContent();
		});

		if( '' == $("#preview_recipient_id").val() ) {
			$('#recipient_name').text('No {%s,0} found', ['{$scheduled_email_type}']);
		}

		EmailTemplateLibrary.ComposeTemplateDialog.Preview.showEmailTemplateContentPreview( 'desktop', this );
	});

};

EmailTemplateLibrary.ComposeTemplateDialog.Preview.showEmailTemplateContentPreview = function( strPreviewMode, objElement ) {
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();
	var emailContentPreviewUrl = objExitTagPath.exitTags.email_template_content_preview_template_library + "&system_message_template_id=" + intSystemMessageTemplateId + "&email_template[id]=" + intEmailTemplateId + "&property_id=" + $('#propertyListForsearch').val() + "&recipient_id=" + $("#preview_recipient_id").val() + "&lease_id=" + $("#preview_lease_id").val() + "&application_id=" + $("#preview_application_id").val();

	var message_preview_iframe		= document.createElement("IFRAME");
	message_preview_iframe.id		="message_preview_iframe";
	message_preview_iframe.setAttribute("src", emailContentPreviewUrl);

	var previewContainer	= ( 'mobile' == strPreviewMode ) ? '#mobile_iframe_holder' : '#desktop_iframe_holder';
	var emptyContainer		= ( 'mobile' == strPreviewMode ) ? '#desktop_iframe_holder' : '#mobile_iframe_holder';
	var activeButton		= ( 'mobile' == strPreviewMode ) ? '#mobile_button' : '#desktop_button';
	var disableButton		= ( 'mobile' == strPreviewMode ) ? '#desktop_button' : '#mobile_button';

	$(emptyContainer).html('');
	$(emptyContainer).addClass( 'hide' );
	$(previewContainer).removeClass( 'hide' );
	$(previewContainer).html(message_preview_iframe);
	$(disableButton).removeClass( 'button selected' );
	$(activeButton).addClass( 'button selected' );

	if( 'mobile' == strPreviewMode ) {
		message_preview_iframe.style.width = 254+"px";
		message_preview_iframe.style.height = "84%";
		message_preview_iframe.frameborder  = "0";
	} else {
		var intDialogHeight	= ( $(window).height() < 700 )? 350 : 550;
		intDialogHeight		= intDialogHeight - 10 - parseInt( $('#attachment_holder').height() );

		$('.desktop_holder').height(intDialogHeight);

		message_preview_iframe.style.width = 680+"px";
		message_preview_iframe.style.height = intDialogHeight+"px";
		message_preview_iframe.style.border = "none";
		message_preview_iframe.scrolling="auto";
	}

	psi.patterns.showLoadingImage({
		strElementSelector: previewContainer
	});

	message_preview_iframe.onload = function(){
		psi.patterns.removeLoadingImage({
			strElementSelector: previewContainer
		});
	}

}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadPropertyComboBox = function() {

	$( '#searchPropertyCombobox' ).val( $('option:selected', '#propertyListForsearch').data('title') )
	$( '#searchPropertyCombobox' ).psiSearchCombobox({
		delay	: 0,
		dataList: $('#propertyListForsearch'),
		select	: function(event, response) {
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadPropertyRecipientsList( response.item.data );
			$('#propertyListForsearch').val( response.item.data );
		}
	});
}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadTestMessagePropertyComboBox = function() {

	$( '#searchPropertyCombobox' ).val( $('option:selected', '#propertyListForsearch').data('title') )
	$( '#searchPropertyCombobox' ).psiSearchCombobox({
		delay	: 0,
		dataList: $('#propertyListForsearch'),
		select	: function(event, response) {
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadTestMessagePropertyRecipientsList( response.item.data );
			$('#propertyListForsearch').val( response.item.data );
		}
	});
}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadRecipientComboBox = function() {

	$( '#searchRecipientCombobox' ).val(  $('option:selected', '#recipientsListForsearch').data('name'))
	$( '#searchRecipientCombobox' ).psiSearchCombobox({
		delay: 0,
		dataList: $('#recipientsListForsearch'),
		select: function(event, response) {
			$('#preview_recipient_id').val( $(response.item.option).data('recipient-id') );
			$('#preview_lease_id').val( $(response.item.option).data('lease-id') );
			$('#preview_application_id').val( $(response.item.option).data('application-id') );
			$('#recipientsListForsearch').val(response.item.data);
		}
	});
}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadPropertyRecipientsList = function( intPropertyId ) {
	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	var strUrl = objExitTagPath.exitTags.preview_email_template + "&email_template[id]=" + intEmailTemplateId  + "&preview_mode=desktop&property_id=" + intPropertyId;

	psi.patterns.ajaxRequest({
		url: strUrl,
		type: 'GET',
		success: function( data ) {
			$('#recipients_select_wrapper').html(data);
			EmailTemplateLibrary.ComposeTemplateDialog.Preview.loadRecipientComboBox();
		}
	});
}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.printMessageContent = function() {
	var printIframe = document.getElementById("message_preview_iframe").contentWindow

	printIframe.focus();// focus on contentWindow is needed on some ie versions
	printIframe.print();
}

EmailTemplateLibrary.ComposeTemplateDialog.Preview.sendTestEmail = function( objElement ) {
	var boolValidEmail		= true;

	var strMsg = '';
	var strSendCopyToValue	= $( '#test_email_addresses' ).val();

	objExitTagPath = EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath();

	if( strSendCopyToValue == '' || strSendCopyToValue.indexOf(';') > -1 || strSendCopyToValue.indexOf(':') > -1 ) {
		boolValidEmail &= false;
		strMsg = __( 'Provide valid email address(es) separated by commas.' );
	} else {
		var arrstrEmailAddresses = strSendCopyToValue.split(',');
		var intLenghtOfArrayOfEmailAddresses = arrstrEmailAddresses.length;
		if( MAX_TEST_EMAIL_COUNT < intLenghtOfArrayOfEmailAddresses ){
			boolValidEmail &= false;
			strMsg = __( 'The number of recipients in the test email field is limited to '+MAX_TEST_EMAIL_COUNT+'.' );
		} else {
			for( var i = 0; i < intLenghtOfArrayOfEmailAddresses; i++ ) {
				if( false == EmailTemplateLibrary.ComposeTemplateDialog.validateEmailAddress( $.trim( arrstrEmailAddresses[i] ) ) ) {
					boolValidEmail &= false;
					strMsg = __( 'Provide valid email address(es) separated by commas.' );
				}
			}
		}
	}

	if( false == boolValidEmail ) {
		$( '#email_template_preview' ).scrollTop(0);
		objExitTagPath.showMessage( 'error', strMsg, 'alert_message_preview', 7000 );
		GtmTracking.addError( 'modal interaction', '', 'send test email', 'email template library > create new template > email preview', strMsg );
	} else {

		var strUrl = objExitTagPath.exitTags.send_test_email_template_library + '&email_template[id]=' + intEmailTemplateId + '&property_id=' + $('#propertyListForsearch').val() + '&recipient_id=' + $("#preview_recipient_id").val()  + "&lease_id=" + $("#preview_lease_id").val() + "&application_id=" + $("#preview_application_id").val();

		psi.patterns.ajaxRequest({
			type	: 'POST',
			url		: strUrl,
			data	: $('#test_email_container').serialize(),
			success	: function( returnedData ) {
				var objJsonMsg = $.parseJSON( returnedData );

				if( true == objJsonMsg.status ) {
					$( '#email_template_preview' ).scrollTop(0);
					objExitTagPath.showMessage( 'success', objJsonMsg.message, 'alert_message_preview' );
				} else {
					strMsg = '<i></i>' + objJsonMsg.message;
					$( '#email_template_preview' ).scrollTop(0);
					objExitTagPath.showMessage( 'error', strMsg, 'alert_message_preview', 7000 );
					GtmTracking.addError( 'modal interaction', '', 'send test email', 'email template library > create new template > email preview', strMsg );
				}
			}
		});
	}
}

EmailTemplateLibrary.ComposeTemplateDialog.loadExitTagsPath = function() {
	var objExitTagPath = '';
	switch( strCallFromSection ) {
		case 'contact_points':
			objExitTagPath = psi.SystemMessages;
			break;
		case 'message_center':
			objExitTagPath = MessageCenter;
			break;
		case 'leads':
			objExitTagPath = ApplicationEmail;
			break;
		case 'customer_dashboard':
			objExitTagPath = psi.Customers;
			break;
		case 'cnt_message_center':
			objExitTagPath = CntMessageCenter;
			break;
		default:
			objExitTagPath = MessageCenter;
	}
	return objExitTagPath;
}
