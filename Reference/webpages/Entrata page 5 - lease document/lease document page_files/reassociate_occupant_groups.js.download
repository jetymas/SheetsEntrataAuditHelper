psi.reassociateOccupantGroups = (function( $ ) {
	function init(){
		//
	}
		
	function mapOldGroupToNewGroup() {
		var thisRef = this;
		$( "#new_customer_relationship_group, #all_associated_properties_select" ).change(function() {
			$('#error_msgs_reassociate' ).hide();
			
			var new_customer_relationship_group_id = $("#new_customer_relationship_group").val();
			var old_customer_relationship_group_id = $("#current_customer_relationship_group_id").val();

			var arr_associated_all_properties = [];
			index = 0;
			
			$("#all_associated_properties_select").find('li').find("input:checked").each(function()  { 
				arr_associated_all_properties[index++] = $(this).val();
		    });
			
			psi.patterns.showLoadingImage({ strElementSelector: '#occupant_type_mapping_div' });
			$("#occupant_type_mapping_div").show();
			psi.patterns.ajaxRequest({ 
				url: thisRef.exitTags.mapOldGroupToNewGroup, 
				strElementSelector: '#occupant_type_mapping_div', 
				data: { 
					"customer_relationship_group[id]": old_customer_relationship_group_id, 
					"new_customer_relationship_group[id]": new_customer_relationship_group_id,
					"associated_properties[id]": arr_associated_all_properties
				},
				complete:function() {
					psi.patterns.removeLoadingImage({ strElementSelector: '#occupant_type_mapping_div' });
				}
			});			
		});
		
		$('#cancel_customer_relationship_group_reassociation, .ui-dialog-titlebar-close').click( function(){
			jQuery('#mod').dialog('close');
			var old_customer_relationship_group_id = $("#old_customer_relationship_group_id").val();
			
			psi.patterns.ajaxRequest({
				strElementSelector: '#add_or_edit_occupant_type_group',
				url: thisRef.exitTags.editCustomerRelationshipGroup,
				type: 'post',
				data: { 
					"customer_relationship_group[id]": old_customer_relationship_group_id 
				}
			});
			
			
		});
		
		$("#reassociate_customer_relationship_group").click( function(){
			insertOrUpdateCustomerRelationshipGroup( thisRef, thisRef.exitTags.updateReassociateOccupantGroups );
		});
		
	}
	
	function insertOrUpdateCustomerRelationshipGroup( thisRef, url ) {
		$('#reassociate_customer_relationship_group').attr('disabled', 'disabled');
		psi.patterns.showLoadingImage({ strElementSelector: '#occupant_type_mapping_div' });
		psi.patterns.ajaxRequest({
			strElementSelector: '',
			url: url,
			type: 'post',
			data: $( '#reassociate-form' ).serialize(),
			success: function( strResponse ) {
				var response = $.parseJSON( strResponse );
				if( 'success' == response['result'] ) {
					parent.psi.patterns.closeLargeDialog();
					jQuery('#mod').dialog('close');					
					
					psi.patterns.ajaxRequest({
						strElementSelector: '#occupant_types_container',
						url: thisRef.exitTags.viewCustomerRelationshipGroups,
						complete:function() {
							$('#success_msgs' ).html( response['message'] ).show();
						}
					});
					
				} else {
					$('#reassociate_customer_relationship_group').attr('disabled', false);
					psi.patterns.removeLoadingImage({ strElementSelector: '#occupant_type_mapping_div' });
					$('#error_msgs_reassociate' ).html( response['message'] ).show();
					setTimeout(function() { $('#error_msgs_reassociate' ).delay(5000).fadeOut('slow'); }, 7000);
				}
			}
		});
	}
	
	function mapPropertyOnInsert( thisRef, url, new_customer_relationship_group_id ) {
		var property_id = $( thisRef ).data('listid');
		
		var arr_associated_all_properties = [];
		index = 0;
		
		$(".assigned ul").find('li').each(function()  { 
			arr_associated_all_properties[index++] = $(this).data('listid');
	    });

		psi.patterns.loadDialog({
			title: __( "Customer Relationship Group Association" ),				
			strUrl: url,
			data: {
				"property[id]": property_id,
				"associated_properties[id]": arr_associated_all_properties,
				"new_customer_relationship_group[id]": new_customer_relationship_group_id,
			},
			width: 1015,
			height: 645
		});
		
	}
		
	return {
		init: init,
		mapOldGroupToNewGroup: mapOldGroupToNewGroup,
		mapPropertyOnInsert: mapPropertyOnInsert,
	};
	
})( jQuery );

