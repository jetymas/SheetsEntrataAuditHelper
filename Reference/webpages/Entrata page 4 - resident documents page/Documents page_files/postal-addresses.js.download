/**
 * This JS is cross browser, cross application compatible. Don't use jQuery in this file.
 * Use only native JS. Test your changes on IE, Firefox, Chrome, Edge. Refer caniuse.com to see
 * browser compatibility before using any function.
 *
 */
// var postalAddresses
var postalAddressesProto = (function() {

	const postalAddressFields = [
		'addressLine1',
		'addressLine2',
		'addressLine3',
		'locality',
		'dependentLocality',
		'administrativeArea',
		'postalCode',
		'sortingCode',
		'country'
	];

	function init( strWrapperId ) {

		var addressBlock = document.querySelector( strWrapperId );

		if( "undefined" === typeof addressBlock ) {
			console.error( 'Postal Address: Address block not found with selector #' + strWrapperId );
			return;
		}

		var countryInput = addressBlock.querySelector( ' .country' );

		if( "undefined" === typeof countryInput ) {
			console.error( 'Postal Address: Country not found with selector #' + strWrapperId );
			return;
		}

		// Check if its already inited
		if( null !== addressBlock.getAttribute( 'data-inited' ) ) {
			return;
		}

		// Add onChange listener for country drop down
		countryInput.addEventListener( "change", function( e ) {
			handleCountryChange( addressBlock, countryInput );
		} );

		addressBlock.setAttribute( 'data-inited', '' );
	}

	function handleCountryChange( addressBlock, countryInput ) {

		var countryDefinition = JSON.parse( postalAddressesCountryDefinitions )[countryInput.value];

		if( 'undefined' === countryDefinition ) {
			console.error( 'Postal Address: Definitions not loaded.' );
		}

		if( -1 !== countryDefinition.format.indexOf( 'administrativeArea' ) ) {
			assertAdministrativeAreas( addressBlock, countryDefinition );
		} else {
			removeAdministrativeAreas( addressBlock );
		}

		triggerChangeEvent( addressBlock.querySelector( "[data-ui-rel='administrativeArea'] select" ) );

		reorderAddressLines( addressBlock, countryDefinition );

		applyLabels( addressBlock, countryDefinition );

		// Put required attribute only if wrapper has that attribute.
		if( null !== addressBlock.getAttribute( 'data-required' ) ) {
			updateRequiredFields( addressBlock, countryDefinition );
		}

		applyPostalCodePattern( addressBlock, countryDefinition );

	}

	function removeAdministrativeAreas( addressBlock ) {
		var administrativeAreaDiv = addressBlock.querySelector( "[data-ui-rel='administrativeArea']" );

		// If current country doesn't have administrativeAreaDiv and new country also doesn't have it,
		// we don't want to do anything here. i.e.: Changing from UK to FR.
		if( administrativeAreaDiv ) {
			var administrativeAreaField = administrativeAreaDiv.querySelector( "select, input" );
			hideElement( administrativeAreaDiv );
			emptyField( administrativeAreaField );
		}

	}

	function reorderAddressLines( addressBlock, countryDefinition ) {
		var arrRequiredOrder = countryDefinition.format.split( /[ \n,-]+/ ).filter( function( item ) {
			return postalAddressFields.indexOf( item.replace( '%', '' ) ) !== -1;
		} );

		// Move country at top
		arrRequiredOrder.unshift( '%country' );

		var currentAddressLineDivs = addressBlock.querySelectorAll( '[data-ui-rel]' );

		var currentAddressLine, strAddressFieldName;
		var currentAddressLines = [];

		// collect address lines and remove it from DOM
		for( var line = 0; line < currentAddressLineDivs.length; line++ ) {
			currentAddressLine = currentAddressLineDivs[line];
			strAddressFieldName = currentAddressLine.getAttribute( 'data-ui-rel' );

			currentAddressLines[strAddressFieldName] = currentAddressLine;
			hideElement( currentAddressLineDivs[line] );
		}

		// re-order
		var sortedLines = [];

		for( line = 0; line < arrRequiredOrder.length; line++ ) {
			var fieldName = arrRequiredOrder[line].replace( '%', '' );

			if( 'undefined' === typeof (currentAddressLines[fieldName]) ) {
				// This line was not present earlier, but new format has it.
				sortedLines[fieldName] = cloneAddressFieldDiv( addressBlock, fieldName, 'addressLine1' );
			} else {
				sortedLines[fieldName] = currentAddressLines[fieldName];
			}

		}

		Object.keys( sortedLines ).forEach( function( fieldName ) {
			addressBlock.querySelector( 'fieldset' ).appendChild( sortedLines[fieldName] );
			showField( sortedLines[fieldName] );
		} );

		// Empty fields that are not present in current format
		Object.keys( currentAddressLines ).forEach( function( fieldName ) {

			if( undefined === sortedLines[fieldName] ) {
				var addressField = addressBlock.querySelector( "[data-ui-rel='" + fieldName + "'] .address-field" );
				emptyField( addressField );
			}
		} );

	}

	function cloneAddressFieldDiv( addressBlock, cloneFor, cloneFrom ) {

		var addressLine1Div = addressBlock.querySelector( "[data-ui-rel='" + cloneFrom + "']" );

		var clonedDiv = addressLine1Div.cloneNode( true );
		clonedDiv.setAttribute( 'data-ui-rel', cloneFor );

		clonedDiv.querySelectorAll( 'select, input, div' ).forEach( function( el ) {
			if( el.getAttribute( 'name' ) ) {
				el.setAttribute( 'name', el.getAttribute( 'name' ).replace( cloneFrom, cloneFor ) );
			}

			if( el.getAttribute( 'class' ) ) {
				el.setAttribute( 'class', el.getAttribute( 'class' ).replace( cloneFrom, cloneFor ) );
			}

			emptyField( el )

			// @FIXME: PP Customisaton
			el.classList.remove( 'has-focus' );

		} );

		return clonedDiv;
	}

	function applyLabels( addressBlock, countryDefinition ) {

		var jsonLabels = {};
		jsonLabels.postalCode = getTranslatedValue( countryDefinition.postal_code_type );
		jsonLabels.administrativeArea = getTranslatedValue( countryDefinition.administrative_area_type );
		jsonLabels.locality = getTranslatedValue( countryDefinition.locality_type );
		jsonLabels.dependentLocality = getTranslatedValue( countryDefinition.dependent_locality_type );
		jsonLabels.addressLine1 = getTranslatedValue( 'addressLine1' );
		jsonLabels.addressLine2 = getTranslatedValue( 'addressLine2' );
		jsonLabels.addressLine3 = getTranslatedValue( 'addressLine3' );
		jsonLabels.sortingCode = getTranslatedValue( 'sortingCode' );
		jsonLabels.country = getTranslatedValue( 'country' );

		for( var fieldName in jsonLabels ) {
			if( jsonLabels.hasOwnProperty( fieldName ) ) {
				var labelElement = addressBlock.querySelector( "[data-ui-rel='" + fieldName + "'] label" );
				if( null !== labelElement ) {
					labelElement.innerHTML = jsonLabels[fieldName] + ':';
				}
			}
		}

	}

	function updateRequiredFields( addressBlock, countryDefinition ) {

		var requiredFields = countryDefinition.required_fields;

		// Remove existing data attributes
		addressBlock.querySelectorAll( '[data-required]' ).forEach( function( element ) {
				element.removeAttribute( 'data-required' );
			}
		);

		// Apply new ones
		for( var i = 0; i < requiredFields.length; i++ ) {
			var addressField = addressBlock.querySelector( "[data-ui-rel='" + requiredFields[i] + "'] .address-field" );
			if( addressField ) {
				addressField.setAttribute( 'data-required', '' );
			}

			var addressLabel = addressBlock.querySelector( "[data-ui-rel='" + requiredFields[i] + "'] label" );
			if( addressLabel ) {
				addressLabel.innerHTML = '<i>*</i>' + addressLabel.innerHTML;
				addressLabel.classList.add( 'req' );
			}
		}

	}

	function applyPostalCodePattern( addressBlock, countryDefinition ) {
		var postalCodeInput = addressBlock.querySelector( ' .postalCode' );
		postalCodeInput.setAttribute( 'pattern', countryDefinition['postal_code_pattern'] );
	}

	function assertAdministrativeAreas( addressBlock, countryDefinition ) {
		var administrativeAreas = countryDefinition.administrative_areas,
			administrativeAreaFieldDiv, newAdministrativeAreaFieldDiv;
			
		administrativeAreaFieldDiv = addressBlock.querySelector( "[data-ui-rel='administrativeArea']" );

		newAdministrativeAreaFieldDiv = createAdministrativeAreaDiv( addressBlock, administrativeAreas );

		if( null === administrativeAreaFieldDiv ) {
			addressBlock.querySelector( 'fieldset' ).appendChild( newAdministrativeAreaFieldDiv );
		} else {
			administrativeAreaFieldDiv.replaceWith( newAdministrativeAreaFieldDiv );
		}
	}

	function createAdministrativeAreaDiv( addressBlock, administrativeAreas ) {

		var fieldType, administrativeAreaDiv, currentAdministrativeAreaField, newAdministrativeAreaField;

		if( 0 === administrativeAreas.length ) {
			fieldType = 'input';
		} else {
			fieldType = 'select';
		}

		if( 'input' === fieldType ) {
			administrativeAreaDiv = cloneAddressFieldDiv( addressBlock, 'administrativeArea', 'addressLine1' );
			currentAdministrativeAreaField = administrativeAreaDiv.querySelector( 'input' );
			newAdministrativeAreaField = document.createElement( 'input' );
			newAdministrativeAreaField.setAttribute( 'type', 'text' );
		} else {
			administrativeAreaDiv = cloneAddressFieldDiv( addressBlock, 'administrativeArea', 'country' );
			currentAdministrativeAreaField = administrativeAreaDiv.querySelector( 'select' );
			newAdministrativeAreaField = document.createElement( 'select' );
		}

		// copy all attributes.
		for( var i = currentAdministrativeAreaField.attributes.length - 1; i > -1; --i ) {

			var attribute = currentAdministrativeAreaField.attributes[i];
			newAdministrativeAreaField.setAttribute( attribute.name, attribute.value );
		}

		// Recreate all options
		newAdministrativeAreaField.innerHTML = '';
		newAdministrativeAreaField.appendChild( new Option(__( 'Select One'), '' ) );
		if( 0 !== administrativeAreas.length ) {
			for( i = 0; i < administrativeAreas.length; i++ ) {
				newAdministrativeAreaField.appendChild( new Option( administrativeAreas[i].name, administrativeAreas[i].code ) );
			}
		}

		enableField( newAdministrativeAreaField );
		showField( newAdministrativeAreaField );

		currentAdministrativeAreaField.replaceWith( newAdministrativeAreaField );

		return administrativeAreaDiv;
	}

	function getTranslatedValue( strValue ) {
		switch( strValue ) {

			// All postal address fields
			case 'addressLine1':
				return __( 'Address Line 1' );
			case 'addressLine2':
				return __( 'Address Line 2' );
			case 'addressLine3':
				return __( 'Address Line 3' );
			case 'locality':
				return __( 'Locality' );
			case 'dependentLocality':
				return __( 'Dependent Locality' );
			case 'administrativeArea':
				return __( 'Administrative Area' );
			case 'postalCode':
				return __( 'Postal Code' );
			case 'sortingCode':
				return __( 'Sorting Code' );
			case 'country':
				return __( 'Country' );

			// All CAdministrativeAreaTypes
			case 'area':
				return __( 'Area' );
			case 'county':
				return __( 'County' );
			case 'department':
				return __( 'Department' );
			case 'do_si':// Korea
				return __( 'Do/Si' );
			case 'emirate':// UAE
				return __( 'Emirate' );
			case 'island':
				return __( 'Island' );
			case 'oblast':// Russia
				return __( 'Oblast' );
			case 'parish':// Ireland, Australia
				return __( 'Parish' );
			case 'prefecture':// Japan, France
				return __( 'Prefecture' );
			case 'province':// Canada
				return __( 'Province' );
			case 'state':// US, India
				return __( 'State' );

			// All LocalityTypes
			case 'city':
				return __( 'City' );
			case 'district':
				return __( 'District' );
			case 'post_town':
				return __( 'Post Town' );
			case 'suburb':
				return __( 'Suburb' );

			// All DependentLocalityTypes
			case 'neighborhood' :
				return __( 'Neighborhood' );
			case 'village_township' :
				return __( 'Village / Township' );
			case 'townland' :
				return __( 'Townland' );

			// All PostalCodeTypes
			case 'eircode':
				return __( 'Eircode' );
			case 'pin':
				return __( 'Pin' );
			case 'postal':
				return __( 'Postal' );
			case 'zip':
				return __( 'Zip' );

			default:
				return strValue;
		}
	}

	function disable( strWrapperId, boolDisabled ) {
		var addressBlock = document.querySelector( strWrapperId ),
			addressFields = addressBlock.querySelectorAll( '[data-ui-rel] select, input' );

		// collect address lines and remove it from DOM

		for( var line = 0; line < addressFields.length; line++ ) {
			if( true === boolDisabled ) {
				disableField( addressFields[line] );
			} else {
				enableField( addressFields[line] );
			}
		}
	}

	function triggerChangeEvent( element ) {
		if( null === element ) {
			return;
		}

		var event;

		if( typeof (Event) === 'function' ) {
			event = new Event( 'change', { bubbles: true } );
		} else {
			event = document.createEvent( 'Event' );
			event.initEvent( 'change', true, true );
		}

		element.dispatchEvent( event );
	}

	function hideElement( element ) {
		element.classList.add( 'hide', 'is-hidden' );
	}

	function showField( element ) {
		element.classList.remove( 'hide', 'is-hidden' );
	}

	function disableField( element ) {
		element.classList.add( 'disabled' );
		element.setAttribute( 'disabled', 'disabled' );
	}

	function enableField( element ) {
		element.classList.remove( 'disabled' );
		element.removeAttribute( 'disabled' );
	}

	function emptyField( element ) {

		// for input
		if( element.getAttribute( 'value' ) ) {
			element.setAttribute( 'value', '' );
		}

		// for select
		if( element.selectedIndex ) {
			element.options[element.selectedIndex].removeAttribute( 'selected' );
		}
	}

	function triggerCountryChange( strWrapperId ) {
		var addressBlock = document.querySelector( strWrapperId );
		triggerChangeEvent( addressBlock.querySelector( "[data-ui-rel='country'] select" ) );
	}

	return {
		init: init,
		disable: disable,
		triggerCountryChange: triggerCountryChange
	};

})();
if( 'undefined' === typeof window.postalAddresses ) {
	window.postalAddresses = postalAddressesProto;
}